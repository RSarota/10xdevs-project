# REST API Plan - 10x-cards

## 1. Resources

### Primary Resources

1. **Flashcards** (`/api/flashcards`)
   - Database table: `flashcards`
   - Represents individual flashcards created manually or generated by AI

2. **Generations** (`/api/generations`)
   - Database table: `generations`
   - Represents AI generation sessions with statistics

3. **Generation Errors** (`/api/generation-errors`)
   - Database table: `generation_error_logs`
   - Logs errors during AI generation process

4. **Users** (`/api/users`)
   - Managed by Supabase Auth
   - User profile and account management operations

## 2. Endpoints

### 2.2 Flashcard Management

#### Get All Flashcards
- **Method:** `GET`
- **Path:** `/api/flashcards`
- **Description:** Retrieve all flashcards for authenticated user
- **Headers:** `Authorization: Bearer {token}`
- **Query Parameters:**
  - `type` (optional): Filter by type (`ai-full`, `ai-edited`, `manual`)
  - `generation_id` (optional): Filter by generation ID
  - `page` (optional, default: 1): Page number
  - `limit` (optional, default: 50, max: 100): Items per page
  - `sort_by` (optional, default: `created_at`): Sort field (`created_at`, `updated_at`)
  - `sort_order` (optional, default: `desc`): Sort order (`asc`, `desc`)
- **Success Response (200):**
```json
{
  "data": [
    {
      "id": "number",
      "user_id": "uuid",
      "generation_id": "number | null",
      "type": "ai-full | ai-edited | manual",
      "front": "string",
      "back": "string",
      "created_at": "timestamp",
      "updated_at": "timestamp"
    }
  ],
  "pagination": {
    "page": "number",
    "limit": "number",
    "total_items": "number",
    "total_pages": "number"
  }
}
```
- **Error Responses:**
  - `401 Unauthorized`: Invalid or missing token
  - `400 Bad Request`: Invalid query parameters

#### Get Single Flashcard
- **Method:** `GET`
- **Path:** `/api/flashcards/{id}`
- **Description:** Retrieve a specific flashcard
- **Headers:** `Authorization: Bearer {token}`
- **Success Response (200):**
```json
{
  "id": "number",
  "user_id": "uuid",
  "generation_id": "number | null",
  "type": "ai-full | ai-edited | manual",
  "front": "string",
  "back": "string",
  "created_at": "timestamp",
  "updated_at": "timestamp"
}
```
- **Error Responses:**
  - `401 Unauthorized`: Invalid token
  - `404 Not Found`: Flashcard not found or doesn't belong to user

#### Create Flashcard
- **Method:** `POST`
- **Path:** `/api/flashcards`
- **Description:** Create a new flashcard (manual or from AI generation)
- **Headers:** `Authorization: Bearer {token}`
- **Request Body:**
```json
{
  "front": "string (required, max 200 chars for manual, TEXT for AI-generated)",
  "back": "string (required, max 500 chars for manual, TEXT for AI-generated)",
  "source": "string (required: 'manual' | 'ai-full' | 'ai-edited')",
  "generation_id": "number (optional, required when source is 'ai-full' or 'ai-edited')"
}
```
- **Success Response (201):**
```json
{
  "id": "number",
  "user_id": "uuid",
  "generation_id": "number | null",
  "type": "manual | ai-full | ai-edited",
  "front": "string",
  "back": "string",
  "created_at": "timestamp",
  "updated_at": "timestamp"
}
```
- **Error Responses:**
  - `401 Unauthorized`: Invalid token
  - `400 Bad Request`: Validation error
    - Manual flashcards: front > 200 chars or back > 500 chars
    - AI flashcards: generation_id not found or doesn't belong to user
  - `404 Not Found`: Generation ID not found

**Business Logic:**
- `source` field determines the flashcard type:
  - `source: 'manual'` → `type: 'manual'`, `generation_id` must be null
  - `source: 'ai-full'` → `type: 'ai-full'`, `generation_id` required (flashcard generated by AI without edits)
  - `source: 'ai-edited'` → `type: 'ai-edited'`, `generation_id` required (flashcard generated by AI with edits)
- When AI flashcard is created, generation statistics are automatically updated:
  - `ai-full` increments `accepted_unedited_count`
  - `ai-edited` increments `accepted_edited_count`
- Validation ensures `generation_id` belongs to authenticated user

#### Update Flashcard
- **Method:** `PATCH`
- **Path:** `/api/flashcards/{id}`
- **Description:** Update an existing flashcard
- **Headers:** `Authorization: Bearer {token}`
- **Request Body:**
```json
{
  "front": "string (optional, max 200 chars for manual, TEXT for AI)",
  "back": "string (optional, max 500 chars for manual, TEXT for AI)"
}
```
- **Success Response (200):**
```json
{
  "id": "number",
  "user_id": "uuid",
  "generation_id": "number | null",
  "type": "ai-full | ai-edited | manual",
  "front": "string",
  "back": "string",
  "created_at": "timestamp",
  "updated_at": "timestamp"
}
```
- **Error Responses:**
  - `401 Unauthorized`: Invalid token
  - `404 Not Found`: Flashcard not found
  - `400 Bad Request`: Validation error

#### Delete Flashcard
- **Method:** `DELETE`
- **Path:** `/api/flashcards/{id}`
- **Description:** Delete a flashcard (requires confirmation)
- **Headers:** `Authorization: Bearer {token}`
- **Success Response (200):**
```json
{
  "message": "Flashcard deleted successfully",
  "id": "number"
}
```
- **Error Responses:**
  - `401 Unauthorized`: Invalid token
  - `404 Not Found`: Flashcard not found

#### Bulk Delete Flashcards
- **Method:** `POST`
- **Path:** `/api/flashcards/bulk-delete`
- **Description:** Delete multiple flashcards at once
- **Headers:** `Authorization: Bearer {token}`
- **Request Body:**
```json
{
  "flashcard_ids": ["number[]"]
}
```
- **Success Response (200):**
```json
{
  "message": "Flashcards deleted successfully",
  "deleted_count": "number"
}
```

### 2.3 AI Generation

#### Generate Flashcards
- **Method:** `POST`
- **Path:** `/api/generations`
- **Description:** Generate flashcard proposals from source text using AI
- **Headers:** `Authorization: Bearer {token}`
- **Request Body:**
```json
{
  "source_text": "string (required, min 1000 chars, max 10000 chars)"
}
```
- **Success Response (201):**
```json
{
  "generation_id": "number",
  "proposals": [
    {
      "front": "string",
      "back": "string",
      "temporary_id": "string (client-side identifier)"
    }
  ],
  "source_text_hash": "string",
  "source_text_length": "number",
  "generation_duration": "number (milliseconds)",
  "created_at": "timestamp"
}
```
- **Error Responses:**
  - `401 Unauthorized`: Invalid token
  - `400 Bad Request`: Source text length outside allowed range (1000-10000 chars)
  - `429 Too Many Requests`: Rate limit exceeded
  - `503 Service Unavailable`: AI service temporarily unavailable

#### Bulk Accept Generated Flashcards
- **Method:** `POST`
- **Path:** `/api/generations/{generation_id}/accept`
- **Description:** Accept and save multiple generated flashcard proposals at once (bulk operation). Alternative: use `POST /api/flashcards` for individual flashcards.
- **Headers:** `Authorization: Bearer {token}`
- **Request Body:**
```json
{
  "flashcards": [
    {
      "temporary_id": "string (client-side identifier for tracking)",
      "front": "string (required)",
      "back": "string (required)",
      "source": "string (required: 'ai-full' | 'ai-edited')"
    }
  ]
}
```
- **Success Response (201):**
```json
{
  "message": "Flashcards accepted successfully",
  "accepted_count": "number",
  "flashcards": [
    {
      "id": "number",
      "user_id": "uuid",
      "generation_id": "number",
      "type": "ai-full | ai-edited",
      "front": "string",
      "back": "string",
      "created_at": "timestamp",
      "updated_at": "timestamp",
      "temporary_id": "string"
    }
  ],
  "generation_stats": {
    "generated_count": "number",
    "accepted_unedited_count": "number",
    "accepted_edited_count": "number"
  }
}
```
- **Error Responses:**
  - `401 Unauthorized`: Invalid token
  - `404 Not Found`: Generation not found or doesn't belong to user
  - `400 Bad Request`: Invalid flashcard data, empty flashcards array, or invalid source value

**Note:** This endpoint is optimized for bulk operations. For creating single flashcards (manual or AI-generated), use `POST /api/flashcards`. The `generation_id` is taken from the URL path, so only `source` values of `ai-full` or `ai-edited` are valid.

#### Get Generation History
- **Method:** `GET`
- **Path:** `/api/generations`
- **Description:** Get user's generation history with statistics
- **Headers:** `Authorization: Bearer {token}`
- **Query Parameters:**
  - `page` (optional, default: 1)
  - `limit` (optional, default: 20, max: 50)
  - `sort_order` (optional, default: `desc`)
- **Success Response (200):**
```json
{
  "data": [
    {
      "id": "number",
      "user_id": "uuid",
      "generated_count": "number",
      "accepted_unedited_count": "number",
      "accepted_edited_count": "number",
      "source_text_hash": "string",
      "source_text_length": "number",
      "generation_duration": "number",
      "created_at": "timestamp",
      "updated_at": "timestamp"
    }
  ],
  "pagination": {
    "page": "number",
    "limit": "number",
    "total_items": "number",
    "total_pages": "number"
  }
}
```

#### Get Single Generation
- **Method:** `GET`
- **Path:** `/api/generations/{id}`
- **Description:** Get details of a specific generation session
- **Headers:** `Authorization: Bearer {token}`
- **Success Response (200):**
```json
{
  "id": "number",
  "user_id": "uuid",
  "generated_count": "number",
  "accepted_unedited_count": "number",
  "accepted_edited_count": "number",
  "source_text_hash": "string",
  "source_text_length": "number",
  "generation_duration": "number",
  "created_at": "timestamp",
  "updated_at": "timestamp",
  "flashcards": [
    {
      "id": "number",
      "type": "ai-full | ai-edited",
      "front": "string",
      "back": "string",
      "created_at": "timestamp"
    }
  ]
}
```
- **Error Responses:**
  - `401 Unauthorized`: Invalid token
  - `404 Not Found`: Generation not found

### 2.5 Error Logs & Monitoring

#### Get Generation Error Logs
- **Method:** `GET`
- **Path:** `/api/generation-errors`
- **Description:** Get error logs from failed generation attempts (admin/debugging)
- **Headers:** `Authorization: Bearer {token}`
- **Query Parameters:**
  - `page` (optional, default: 1)
  - `limit` (optional, default: 20)
  - `error_code` (optional): Filter by error code
- **Success Response (200):**
```json
{
  "data": [
    {
      "id": "number",
      "user_id": "uuid",
      "source_text_hash": "string",
      "source_text_length": "number",
      "error_code": "string",
      "error_message": "string",
      "created_at": "timestamp"
    }
  ],
  "pagination": {
    "page": "number",
    "limit": "number",
    "total_items": "number",
    "total_pages": "number"
  }
}
```

### 2.6 Statistics & Analytics

#### Get User Statistics
- **Method:** `GET`
- **Path:** `/api/users/me/statistics`
- **Description:** Get comprehensive statistics for the authenticated user
- **Headers:** `Authorization: Bearer {token}`
- **Success Response (200):**
```json
{
  "flashcards": {
    "total": "number",
    "by_type": {
      "manual": "number",
      "ai-full": "number",
      "ai-edited": "number"
    }
  },
  "generations": {
    "total_sessions": "number",
    "total_generated": "number",
    "total_accepted": "number",
    "acceptance_rate": "number (percentage)",
    "edit_rate": "number (percentage)"
  }
}
```

## 3. Authentication & Authorization

### Authentication Mechanism
The API uses **JWT (JSON Web Token)** based authentication provided by Supabase Auth.

#### Implementation Details:

1. **Token Types:**
   - **Access Token**: Short-lived token (1 hour) for API authentication
   - **Refresh Token**: Long-lived token (30 days) for obtaining new access tokens

2. **Token Usage:**
   - All protected endpoints require the `Authorization` header: `Bearer {access_token}`
   - Tokens are issued upon successful login/registration
   - Tokens must be validated on every request

3. **Token Refresh:**
   - When access token expires (401 with specific error), client should use refresh token
   - Endpoint: `POST /api/auth/refresh` with refresh token in body

4. **Session Management:**
   - Sessions managed by Supabase Auth
   - Session state persisted in secure HTTP-only cookies (optional, for web)
   - Support for multiple concurrent sessions per user

### Authorization Model

1. **Row-Level Security (RLS):**
   - Implemented at database level using PostgreSQL RLS policies
   - Each table enforces user_id matching with authenticated user
   - Prevents unauthorized access to other users' data

2. **Resource Ownership:**
   - Users can only access resources they own (flashcards, generations, sessions)
   - Validated by checking `user_id` column matches authenticated user's ID

3. **Role-Based Access:**
   - Initial MVP: Single role (authenticated user)
   - Future consideration: Admin role for accessing error logs and analytics

## 4. Validation & Business Logic

### 4.1 Validation Rules

#### Flashcards Resource
- **Front field:**
  - Required for creation
  - Manual flashcards: max 200 characters
  - AI-generated: TEXT (no strict limit, but validated by AI generation)
  - Cannot be empty or whitespace only
  
- **Back field:**
  - Required for creation
  - Manual flashcards: max 500 characters
  - AI-generated: TEXT (no strict limit)
  - Cannot be empty or whitespace only

- **Source field:**
  - Required for creation
  - Must be one of: `manual`, `ai-full`, `ai-edited`
  - Determines the flashcard type stored in database (same value as source)

- **Type field (database):**
  - Must be one of: `ai-full`, `ai-edited`, `manual`
  - Set automatically by server based on `source` parameter
  - Client cannot set this field directly

- **Generation ID field:**
  - Optional for manual flashcards (must be null when `source: 'manual'`)
  - Required when `source` is `ai-full` or `ai-edited`
  - Must reference valid generation record belonging to authenticated user
  - Validated against `generations` table

#### Generations Resource
- **Source text:**
  - Required
  - Minimum: 1000 characters
  - Maximum: 10,000 characters
  - Cannot be only whitespace

- **Hash validation:**
  - Source text hash (SHA-256) calculated server-side
  - Used to detect duplicate generation attempts
  - Optional: Cache results for identical inputs

#### User Registration
- **Email:**
  - Required
  - Must be valid email format
  - Must be unique (enforced by Supabase)
  
- **Password:**
  - Required
  - Minimum 8 characters
  - Recommended: At least one uppercase, one lowercase, one number

### 4.2 Business Logic Implementation

#### AI Generation Flow
1. **Request Validation:**
   - Validate source text length (1000-10000 chars)
   - Calculate source_text_hash (SHA-256)
   - Check for recent duplicate (optional optimization)

2. **AI API Call:**
   - Send request to Azure OpenAI Service via Azure API Management
   - Include API key in header: `x-api-key`
   - Set appropriate timeout (e.g., 30 seconds)
   - Parse and validate AI response

3. **Error Handling:**
   - On failure, log error to `generation_error_logs` table
   - Return user-friendly error message
   - Don't expose internal API details to client

4. **Success Response:**
   - Create record in `generations` table
   - Store generation metadata (count, duration, hash, length)
   - Return proposals to client (not yet persisted as flashcards)
   - Client stores proposals temporarily with `temporary_id`

5. **Acceptance Flow:**
   - Client can use two methods to accept flashcards:
     - **Single flashcard**: `POST /api/flashcards` with `source` (`ai-full` | `ai-edited`) and `generation_id` fields
     - **Bulk operation**: `POST /api/generations/{generation_id}/accept` with array of flashcards
   - Insert flashcard(s) into database with `type` matching `source` value
   - Update generation statistics (accepted_unedited_count, accepted_edited_count) automatically

#### Statistics Calculation
1. **Generation Statistics:**
   - Total sessions: COUNT of generations
   - Total generated: SUM of generated_count
   - Total accepted: SUM of (accepted_unedited_count + accepted_edited_count)
   - Acceptance rate: (total_accepted / total_generated) * 100
   - Edit rate: (SUM of accepted_edited_count / total_accepted) * 100

2. **Study Statistics:**
   - Total reviews: COUNT of all review submissions
   - Average quality: AVG of quality scores
   - Streak calculation: Consecutive days with at least one study session
