---
import AuthLayout from "../../layouts/AuthLayout.astro";
import { ForgotPasswordForm } from "../../components/auth/ForgotPasswordForm";
import { Card, CardContent, Stack } from "../../components/apple-hig";
import { KeyRound } from "lucide-react";
import AuthMessage from "../../components/auth/AuthMessage.astro";
import AuthPageHeader from "../../components/auth/AuthPageHeader.astro";
import { createSupabaseServerInstance } from "../../db/supabase.client";
import { isRecoverySession } from "../../lib/utils/recoverySession";
import { getAuthErrorMessage } from "../../lib/constants/auth";

export const prerender = false;

// Check if user is already authenticated (but not recovery sessions)
const supabase =
  Astro.locals.supabase ??
  createSupabaseServerInstance({
    cookies: Astro.cookies,
    headers: Astro.request.headers,
  });

const {
  data: { user },
} = await supabase.auth.getUser();

// Redirect authenticated users to dashboard (but not recovery sessions)
if (user && !isRecoverySession(Astro.cookies)) {
  await supabase.flushPendingCookies();
  return Astro.redirect("/dashboard");
}

// Check for error messages from confirmation
const error = Astro.url.searchParams.get("error");
const errorMessage = Astro.url.searchParams.get("message");

await supabase.flushPendingCookies();
---

<AuthLayout title="Odzyskiwanie hasła - 10xCards">
  <Stack direction="vertical" spacing="lg">
    <!-- Error Message -->
    {
      error && (
        <AuthMessage
          type="error"
          title={getAuthErrorMessage(error)}
          message={errorMessage ? decodeURIComponent(errorMessage) : undefined}
          errorKey={error}
        />
      )
    }

    <!-- Header -->
    <AuthPageHeader
      icon={KeyRound}
      iconColor="text-[hsl(var(--apple-orange))]"
      iconBgColor="bg-[hsl(var(--apple-orange))]/10"
      title="Odzyskaj hasło"
      description="Nie pamiętasz hasła? Pomożemy Ci je zresetować."
    />

    <!-- Forgot Password Form Card -->
    <Card elevation="md" padding="xl" variant="grouped">
      <CardContent>
        <ForgotPasswordForm client:load />
      </CardContent>
    </Card>
  </Stack>
</AuthLayout>
