---
import { createSupabaseServerInstance } from "../../db/supabase.client";
import { verifyAuthToken } from "../../lib/services/authVerificationService";

// This page handles Supabase email confirmations and password recovery links.
// The verification is performed on the server using the Supabase SSR client
// so that session cookies are managed consistently with the rest of the app.
export const prerender = false;

// Use Supabase instance from locals if available, otherwise create new one
const supabase =
  Astro.locals.supabase ??
  createSupabaseServerInstance({
    cookies: Astro.cookies,
    headers: Astro.request.headers,
  });

// Parse URL parameters
const params = {
  token: Astro.url.searchParams.get("token"),
  tokenHash: Astro.url.searchParams.get("token_hash"),
  code: Astro.url.searchParams.get("code"),
  type: Astro.url.searchParams.get("type"),
  error: Astro.url.searchParams.get("error"),
  errorDescription: Astro.url.searchParams.get("error_description") ?? Astro.url.searchParams.get("message") ?? "",
};

// Verify authentication token
const result = await verifyAuthToken(params, supabase, Astro.cookies);

// Flush cookies and redirect
await supabase.flushPendingCookies();

// Build redirect URL with error message if needed
const redirectUrl =
  result.errorKey && result.message
    ? `${result.redirectTo}?error=${result.errorKey}&message=${encodeURIComponent(result.message)}`
    : result.redirectTo;

return Astro.redirect(redirectUrl);
---
