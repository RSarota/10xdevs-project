---
import AuthLayout from "../../layouts/AuthLayout.astro";
import { RegisterForm } from "../../components/auth/RegisterForm";
import { Card, CardContent, Stack } from "../../components/apple-hig";
import { UserPlus } from "lucide-react";
import AuthPageHeader from "../../components/auth/AuthPageHeader.astro";
import { createSupabaseServerInstance } from "../../db/supabase.client";
import { isRecoverySession } from "../../lib/utils/recoverySession";

export const prerender = false;

// Check if user is already authenticated (but not recovery sessions)
const supabase =
  Astro.locals.supabase ??
  createSupabaseServerInstance({
    cookies: Astro.cookies,
    headers: Astro.request.headers,
  });

const {
  data: { user },
} = await supabase.auth.getUser();

// Redirect authenticated users to dashboard (but not recovery sessions)
if (user && !isRecoverySession(Astro.cookies)) {
  await supabase.flushPendingCookies();
  return Astro.redirect("/dashboard");
}

await supabase.flushPendingCookies();
---

<AuthLayout title="Rejestracja - 10xCards">
  <Stack direction="vertical" spacing="lg">
    <!-- Header -->
    <AuthPageHeader
      icon={UserPlus}
      iconColor="text-[hsl(var(--apple-green))]"
      iconBgColor="bg-[hsl(var(--apple-green))]/10"
      title="Utwórz konto"
      description="Dołącz do tysięcy studentów, którzy uczą się mądrzej z 10xCards."
    />

    <!-- Register Form Card -->
    <Card elevation="md" padding="xl" variant="grouped">
      <CardContent>
        <RegisterForm client:load />
      </CardContent>
    </Card>
  </Stack>
</AuthLayout>
