---
import AuthLayout from "../../layouts/AuthLayout.astro";
import { ResetPasswordForm } from "../../components/auth/ResetPasswordForm";
import { Card, CardContent, Stack } from "../../components/apple-hig";
import { Lock } from "lucide-react";
import AuthPageHeader from "../../components/auth/AuthPageHeader.astro";
import { createSupabaseServerInstance } from "../../db/supabase.client";
import { isRecoverySession } from "../../lib/utils/recoverySession";
import { AUTH_ERROR_KEYS } from "../../lib/constants/auth";

export const prerender = false;

// Verify recovery session exists
if (!isRecoverySession(Astro.cookies)) {
  const message = "Link resetowania hasła jest nieprawidłowy lub wygasł";
  return Astro.redirect(
    `/auth/forgot-password?error=${AUTH_ERROR_KEYS.CONFIRMATION_FAILED}&message=${encodeURIComponent(message)}`
  );
}

// Check if user has a valid session
const supabase =
  Astro.locals.supabase ??
  createSupabaseServerInstance({
    cookies: Astro.cookies,
    headers: Astro.request.headers,
  });

const {
  data: { user },
  error: userError,
} = await supabase.auth.getUser();

// If no user or error, redirect to forgot password
if (userError || !user) {
  await supabase.flushPendingCookies();
  const message = "Sesja wygasła. Spróbuj ponownie zresetować hasło.";
  return Astro.redirect(
    `/auth/forgot-password?error=${AUTH_ERROR_KEYS.CONFIRMATION_FAILED}&message=${encodeURIComponent(message)}`
  );
}

await supabase.flushPendingCookies();
---

<AuthLayout title="Resetowanie hasła - 10xCards">
  <Stack direction="vertical" spacing="lg">
    <!-- Header -->
    <AuthPageHeader
      icon={Lock}
      iconColor="text-[hsl(var(--apple-purple))]"
      iconBgColor="bg-[hsl(var(--apple-purple))]/10"
      title="Nowe hasło"
      description="Ustaw nowe, bezpieczne hasło dla swojego konta."
    />

    <!-- Reset Password Form Card -->
    <Card elevation="md" padding="xl" variant="grouped">
      <CardContent>
        <ResetPasswordForm client:load />
      </CardContent>
    </Card>
  </Stack>
</AuthLayout>
