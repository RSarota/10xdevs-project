---
import AuthLayout from "../../layouts/AuthLayout.astro";
import { LoginForm } from "../../components/auth/LoginForm";
import { Card, CardContent, Stack } from "../../components/apple-hig";
import { LogIn } from "lucide-react";
import AuthMessage from "../../components/auth/AuthMessage.astro";
import AuthPageHeader from "../../components/auth/AuthPageHeader.astro";
import { createSupabaseServerInstance } from "../../db/supabase.client";
import { isRecoverySession } from "../../lib/utils/recoverySession";
import { getAuthErrorMessage } from "../../lib/constants/auth";

export const prerender = false;

// Check if user is already authenticated
const supabase =
  Astro.locals.supabase ??
  createSupabaseServerInstance({
    cookies: Astro.cookies,
    headers: Astro.request.headers,
  });

const {
  data: { user },
} = await supabase.auth.getUser();

// Redirect authenticated users to dashboard (but not recovery sessions)
if (user && !isRecoverySession(Astro.cookies)) {
  await supabase.flushPendingCookies();
  return Astro.redirect("/dashboard");
}

// Check for confirmation success or error messages
const confirmed = Astro.url.searchParams.get("confirmed");
const error = Astro.url.searchParams.get("error");
const errorMessage = Astro.url.searchParams.get("message");

await supabase.flushPendingCookies();
---

<AuthLayout title="Logowanie - 10xCards">
  <Stack direction="vertical" spacing="lg">
    <!-- Success Message -->
    {
      confirmed && (
        <AuthMessage
          type="success"
          title="Email potwierdzony!"
          message="Twoje konto zostało aktywowane. Możesz się teraz zalogować."
        />
      )
    }

    <!-- Error Message -->
    {
      error && (
        <AuthMessage
          type="error"
          title={getAuthErrorMessage(error)}
          message={errorMessage ? decodeURIComponent(errorMessage) : undefined}
          errorKey={error}
        />
      )
    }

    <!-- Header -->
    <AuthPageHeader
      icon={LogIn}
      iconColor="text-[hsl(var(--apple-blue))]"
      iconBgColor="bg-[hsl(var(--apple-blue))]/10"
      title="Zaloguj się"
      description="Witamy z powrotem! Wprowadź swoje dane aby kontynuować."
    />

    <!-- Login Form Card -->
    <Card elevation="md" padding="xl" variant="grouped">
      <CardContent>
        <LoginForm client:load />
      </CardContent>
    </Card>
  </Stack>
</AuthLayout>
